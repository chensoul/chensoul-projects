management.endpoint.health.show-details: "ALWAYS"
management.endpoints.web.exposure.include: "*"

# Sharding Sphere 不支持数据库健康检查
management.health.db.enabled: false
management.health.circuitbreakers.enabled: true
management.info.git.enabled: true
management.info.git.mode: full

spring:
  #  application.name: @artifactId@
  main:
    allow-bean-definition-overriding: true

#spring.datasource:
#  url: jdbc:mysql://${MYSQL_HOST:mysql}:3306/chensoul-cloud?connectTimeout=2000&socketTimeout=150000&allowMultiQueries=true&useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai
#  driver-class-name: com.mysql.cj.jdbc.Driver
#  username: ${MYSQL_USER:root}
#  password: ${MYSQL_PASSWORD:123456}

spring.shardingsphere:
  datasource:
    names:
      master,slave
    master:
      type: com.zaxxer.hikari.HikariDataSource
      driver-class-name: com.mysql.cj.jdbc.Driver
      jdbcUrl: jdbc:mysql://${mysql-master:mysql-master}:3307/chensoul-cloud?connectTimeout=2000&socketTimeout=150000&allowMultiQueries=true&useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai
      username: ${MYSQL_USER:root}
      password: ${MYSQL_PASSWORD:123456}
    slave:
      type: com.zaxxer.hikari.HikariDataSource
      driver-class-name: com.mysql.cj.jdbc.Driver
      jdbcUrl: jdbc:mysql://${mysql-slave:mysql-slave}:3308/chensoul-cloud?connectTimeout=2000&socketTimeout=150000&allowMultiQueries=true&useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai
      username: ${MYSQL_USER:root}
      password: ${MYSQL_PASSWORD:123456}
  masterslave:
    # 最终的数据源名称
    name: dataSource
    load-balance-algorithm-type: round_robin
    # 主库数据源名称
    master-data-source-name: master
    # 从库数据源名称列表，多个逗号分隔
    slave-data-source-names: slave
  props:
    sql:
      show: true


spring.redis:
  port: 6379
  host: ${redis:redis}
  timeout: 3000
  password: 123456

eureka:
  instance:
    prefer-ip-address: true
    instance-id: ${spring.cloud.client.ip-address}:${server.port}
    # 客户端向注册中心发送心跳的时间间隔，默认30秒
    leaseRenewalIntervalInSeconds: 5
    #注册中心在收到客户端心跳之后，等待下一次心跳的超时时间，如果在这个时间内没有收到下次心跳，则移除该客户端。默认90秒
    leaseExpirationDurationInSeconds: 30
  client:
    service-url:
      defaultZone: http://${eureka:eureka}:8761/eureka/
    initialInstanceInfoReplicationIntervalSeconds: 5
    registryFetchIntervalSeconds: 5

mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  global-config:
    db-config:
      id-type: ASSIGN_ID

springdoc:
  swagger-ui:
    oauth:
      clientId: messaging-client
      clientSecret: secret
  oAuthFlow:
    tokenUrl: ${gateway:gateway}:8443/auth/oauth2/token

feign:
  client:
    config:
      default:
        loggerLevel: HEADERS
        connectTimeout: 5000
        readTimeout: 5000
  httpclient:
    max-connections: 200 # 最大的连接数
    max-connections-per-route: 50 # 每个路径的最大连接数
    ok-http:
      read-timeout: 5s
  okhttp:
    enabled: true
    loadbalancer:
      enabled: true
  circuitbreaker:
    enabled: true

resilience4j.circuitbreaker:
  instances:
    authservice:
      allowHealthIndicatorToFail: false
      registerHealthIndicator: true
      slidingWindowType: COUNT_BASED
      slidingWindowSize: 5
      failureRateThreshold: 50
      waitDurationInOpenState: 10000
      permittedNumberOfCallsInHalfOpenState: 3
      automaticTransitionFromOpenToHalfOpenEnabled: true
      ignoreExceptions:
        - com.chensoul.core.exception.InvalidInputException
        - com.chensoul.core.exception.NotFoundException

resilience4j.ratelimiter:
  instances:
    authservice:
      limitForPeriod: 10
      limitRefreshPeriod: 5s
      timeoutDuration: 0

resilience4j.retry:
  instances:
    authservice:
      maxAttempts: 3
      waitDuration: 1000
      retryExceptions:
        - java.io.IOException
        - java.util.concurrent.TimeoutException



spring.cloud.zipkin:
  base-url: http://${zipkin:zipkin}:9411/
  sender:
    type: webmvc
spring.cloud.sleuth:
  sampler:
    probability: 1

logging:
  level:
    com.chensoul: DEBUG
    org.apache.coyote.http11.Http11InputBuffer: DEBUG
    org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping: DEBUG
    org.springframework.boot.autoconfigure.web.reactive.error.AbstractErrorWebExceptionHandler: DEBUG
